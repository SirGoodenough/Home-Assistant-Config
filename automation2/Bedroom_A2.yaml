---
  #####################################################
  # Bedroom                                           #
  #####################################################
  - id: 1a863145-656e-4dd6-8cbf-1de4bc3665f3
      # Complain if the bedroom door is still open shortly 
      #   before the Bedroom AC is scheduled to turn on
    mode: queued
    alias: Bedroom Door is Open
    initial_state: on
    trigger:
      - platform: time
        at: '19:34:06'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.bedroom
          state: 'on'
        - condition: numeric_state
          entity_id: sensor.bedroom_fan_si7021_temperature
          above: input_number.bedroom_auto_temp
        - condition: state
          entity_id: input_boolean.bedroom_auto_fan
          state: 'on'
    action:
      - service: tts.cloud_say
        data:
          entity_id: media_player.kitchen_display, media_player.living_room_speaker
          message: "The Bedroom door is open."
          options:
            gender: female
          language: en-US
          # Send Warning...
      - service: mqtt.publish
        data:
          topic: rf433/Bedroom
          payload: 'OFF'
          retain: true
          # Force the switch closed.
          #  Assume someone checked the door.

  - id: 92fa7b06-d6d5-426e-a197-15cafdce4d6b
      # Set the fan speed based on room Temperature
    mode: restart
    alias: Bedroom Fan Auto Mode
    initial_state: on
    trigger:
      - platform: state
        entity_id: sensor.bedroom_fan_si7021_temperature
      - platform: state
        entity_id: input_boolean.bedroom_auto_fan
        to: 'on'
      - platform: time
        at: '20:00:04'
    condition:
      condition: and
      conditions:
        - condition: time
          after: '19:59:57'
          before: '09:12:53'
        - condition: state
          entity_id: input_boolean.bedroom_auto_fan
          state: 'on'
    action:
    - service: mqtt.publish
      data_template:
        topic: "Bedroom_Fan/cmnd/FanSpeed"
        payload: >
          {% set bte = states('sensor.bedroom_fan_si7021_temperature') | float %}
          {% set bat = (states('input_number.bedroom_auto_temp') | float) -1 %}
          {% if bte < bat %}
            0
          {% elif bte < (bat + 5.5) %}
            1
          {% elif bte < (bat + 7.5) %} 
            2
          {% else %} 
            3
          {% endif %}

  - id: 66849a21-2bb7-4a68-9795-38e9a1c475f1
      # start Bedroom ac at a time
    mode: queued
    alias: Bedroom AC Control
    initial_state: on
    trigger:
      - platform: time
        at: '20:34:06'    
      - platform: state
        entity_id: input_boolean.bedroom_auto_fan
        to: 'on'
    condition:
      condition: and
      conditions:
        - condition: time
          after: '19:59:57'
          before: '09:12:53'
        - condition: state
          entity_id: input_boolean.bedroom_auto_fan
          state: 'on'
        - condition: state
          entity_id: binary_sensor.bedroom
          state: 'off'
    action:
      - service: climate.turn_on
        target:
          entity_id: climate.gemodule5384
      - service: climate.set_temperature
        data_template:
          entity_id: climate.gemodule5384
          temperature: "{{ states.input_number.bedroom_auto_temp.state | float }}"

  - id: 7a06edf5-cd41-43f7-8fff-15ae61551090
      # set Bedroom ac temp from the input slider
    mode: queued
    alias: Bedroom AC Temp
    initial_state: on
    trigger:
      - platform: state
        entity_id: input_number.bedroom_auto_temp
    condition:
      condition: and
      conditions:
        - condition: time
          after: '19:59:57'
          before: '09:12:53'
        - condition: state
          entity_id: input_boolean.bedroom_auto_fan
          state: 'on'
    action:
      - service: climate.set_temperature
        data_template:
          entity_id: climate.gemodule5384
          temperature: "{{ states.input_number.bedroom_auto_temp.state | float }}"

  - id: 15aa3b87-2173-4d8b-aa63-4ee259fda5b0
      # Turn the fan off in the morning to wake my ass up.
      #  And make darn sure it's off...
    mode: queued
    alias: Bedroom Fan Auto Off Mode
    initial_state: on
    trigger:
    - platform: time
      at: '09:12:58'
    - platform: time
      at: '09:20:58'
    condition:
      - condition: state
        entity_id: input_boolean.bedroom_auto_fan
        state: 'on'
    action:
    # Stop fan
    - service: mqtt.publish
      data:
        topic: "Bedroom_Fan/cmnd/FanSpeed"
        payload: 0
    # Stop AC  
    - service: climate.turn_off
      target:
        entity_id: climate.gemodule5384

  - id: d3edc532-448c-432c-84c7-b2a0dc32fd84
        # turn off the stuff when you turn the automation trigger off.
    mode: queued
    alias: Bedroom Fan bedroom_auto_temp Off Mode
    initial_state: on
    trigger:
    - platform: state
      entity_id: input_number.bedroom_auto_temp
      to: 'off'
    action:
    # Stop fan
    - service: mqtt.publish
      data:
        topic: "Bedroom_Fan/cmnd/FanSpeed"
        payload: 0
    # Stop AC  
    - service: climate.turn_off
      target:
        entity_id: climate.gemodule5384
