---
  #####################################################
  # Bedroom                                           #
  #####################################################
  - id: 1a863145-656e-4dd6-8cbf-1de4bc3665f3
      # Complain if the bedroom door is still open shortly 
      #   before the Bedroom AC is scheduled to turn on
    alias: Bedroom Door is Open
    initial_state: on
    trigger:
      - platform: time
        at: '19:34:06'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.bedroom
          state: 'on'
        - condition: numeric_state
          entity_id: sensor.bedroom_fan_si7021_temperature
          above: input_number.bedroom_auto_temp
        - condition: state
          entity_id: input_boolean.bedroom_auto_fan
          state: 'on'
    action:
      - service: tts.cloud_say
        data:
          entity_id: media_player.kitchen_display, media_player.living_room_speaker
          message: "The Bedroom door is open."
          options:
            gender: female
          language: en-US

  - id: 66849a21-2bb7-4a68-9795-38e9a1c475f1
      # start Bedroom ac
    alias: Bedroom AC Control
    initial_state: on
    trigger:
      - platform: time
        at: '20:34:06'
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.bedroom
          state: 'on'
        - condition: numeric_state
          entity_id: sensor.bedroom_fan_si7021_temperature
          above: input_number.bedroom_auto_temp
    action:
      - service: climate.turn_on
        target:
          device_id: 0ca739cff0bf4cf29082e209e5bd03b6
      - service: climate.set_temperature
        data:
          temperature: states.input_number.bedroom_auto_temp
        target:
          device_id: 0ca739cff0bf4cf29082e209e5bd03b6

  - id: 92fa7b06-d6d5-426e-a197-15cafdce4d6b
      # Set the fan speed based on Temperature
    alias: Bedroom Fan Auto Mode
    initial_state: on
    trigger:
      - platform: state
        entity_id: sensor.bedroom_fan_si7021_temperature
      - platform: state
        entity_id: input_boolean.bedroom_auto_fan
        to: 'on'
      - platform: time
        at: '20:00:04'
    condition:
      condition: and
      conditions:
        - condition: time
          after: '19:59:57'
          before: '09:12:53'
        - condition: state
          entity_id: input_boolean.bedroom_auto_fan
          state: 'on'
    action:
    - service: mqtt.publish
      data_template:
        topic: "Bedroom_Fan/cmnd/FanSpeed"
        payload: >
          {% set bte = states('sensor.bedroom_fan_si7021_temperature') | float %}
          {% set bat = states('input_number.bedroom_auto_temp') | float %}
          {% if bte < bat %}
            0
          {% elif bte < (bat + 5.5) %}
            1
          {% elif bte < (bat + 8.5) %} 
            2
          {% else %} 
            3
          {% endif %}

  - id: 15aa3b87-2173-4d8b-aa63-4ee259fda5b0
      # Turn the fan off in the morning to wake my ass up.
      #  And make darn sure it's off...
    alias: Bedroom Fan Auto Off Mode
    initial_state: on
    trigger:
    - platform: state
      entity_id: input_number.bedroom_auto_temp
      to: 'off'
    - platform: time
      at: '09:12:58'
    - platform: time
      at: '09:15:58'
    - platform: time
      at: '09:20:58'
    condition:
      - condition: state
        entity_id: input_boolean.bedroom_auto_fan
        state: 'on'
      - condition: not
        conditions:
        - condition: state
          entity_id: fan.bedroom_fan
          state: 'off'
    action:
    # Stop fan
    - service: mqtt.publish
      data:
        topic: "Bedroom_Fan/cmnd/FanSpeed"
        payload: 0
    # Stop AC  
    - service: climate.turn_off
      target:
        device_id: 0ca739cff0bf4cf29082e209e5bd03b6
