---
#####################################################
#                                                   #
# System                                            #
#                                                   #
#####################################################

####################################################
# Sonoff Bridge Demultiplexer                      #
####################################################

- id: cef2adcb-a4fc-4205-8c13-e3416847bf7b
  initial_state: on
  alias: rfbridge_RfReceived_demultiplexer
  mode: queued
  # Gets info from RF-Bridges and sends them to the python script to generate
  #   individual MQTT topics for them.
  #  Codes recieved from room devices.
  trigger:
    - platform: mqtt
      topic: RFBridge/tele/RESULT
    - platform: mqtt
      topic: RFBridge2/tele/RESULT
  condition:
    - condition: template
      value_template: >
        {{ trigger.payload_json is defined and
          trigger.payload_json.RfReceived is defined and 
          trigger.payload_json.RfReceived.Data is defined }}
  action:
    service: python_script.rfbridge2_demux
    data:
      payload: "{{trigger.payload_json.RfReceived.Data}}"

- id: d6ad7aff-f806-4c75-ab1e-886cba8ef2f9
  initial_state: on
  alias: rfbridge_RfCode_demultiplexer
  mode: queued
  # Gets info from RF-Bridges and sends them to the python script to generate
  #   individual MQTT topics for them.
  #  Codes generated from RF-Bridges.
  trigger:
    - platform: mqtt
      topic: RFBridge/tele/RESULT
    - platform: mqtt
      topic: RFBridge2/tele/RESULT
  condition:
    - condition: template
      value_template: >
        {{ trigger.payload_json is defined and
          trigger.payload_json.RfCode is defined }}
  action:
    service: python_script.rfbridge2_demux
    data:
      payload: "{{trigger.payload_json.RfCode}}"

####################################################
# Dark out?                                        #
####################################################
- id: c4d89216-e97a-470b-82e9-cb9e4e66e601
  initial_state: on
  alias: MQTT Dark Switch
  mode: queued
  trigger:
    - platform: state
      entity_id: binary_sensor.dark_outside
  action:
    - service: mqtt.publish
      data:
        retain: true
        topic: "Outside/cmnd/EVENT"
        payload: >-
          {% if trigger.to_state.state == 'on' %}
            DARK
          {% else %}
            DAY
          {% endif %}

####################################################
# Daily Back-up                                    #
####################################################
- id: ea70e8a8-45bf-4adb-b1cf-85b12dd5129e
  alias: Daily Backup
  initial_state: on
  trigger:
    - platform: time
      at: 06:18:14
  action:
    - service: hassio.addon_start
      data:
        addon: 3490a758_remote_backup

####################################################
# MQTT Restart Tasmota                             #
####################################################
####    Use this automation to get all your devices in sync, including
####     power state, immediately after Home Assistant is (re)started.
####    Also taking this opportunity to start other things up for a clean
####     restart.
- id: c9484bd1-6c87-4cfc-a018-1572be06d402
  alias: Power state on HA start-up
  initial_state: on
  trigger:
    - platform: homeassistant
      event: start
  action:
    - delay: 00:00:22
    - alias: Make sure EZ Buttons are active
      service: script.tasmota_ez_button_for_update_and_restart_all_2022_01_07a
    - delay: 00:00:22
    - alias: Push the Tasmota Restart Button
      service: button.press
      target:
        entity_id: button.ez_restart_button_tasmota
    - delay: 00:00:22
    - alias: "Assume its dark- Prevents IDK state and lights not working"
      service: mqtt.publish
      data:
        topic: Outside/cmnd/EVENT
        payload: "DARK"
        retain: true
    - alias: Make sure ChromeCast is on
      service: switch.turn_on
      entity_id: switch.chromecast
    - alias: Make sure Dust Collector is off
      service: switch.turn_off
      entity_id: switch.dust_collector
    - alias: Make sure Bathroom is not Muted
      service: script.google_mute
      data:
        status: false
        entities: media_player.bathroom_speaker

####################################################
# Restart Eldrad if it stops Pinging               #
####################################################
- id: 90c6e8db-9079-4a34-997b-e73a7bdc497a
  alias: restart eldrad
  description: Watch Eldrad and restart it if it's dead.
  trigger:
  - platform: state
    entity_id: input_button.restart_eldrad
  - platform: state
    entity_id:
    - device_tracker.eldrad_2
    to: not_home
    for:
      minutes: 12
  action:
  - service: switch.turn_off
    target:
      entity_id: switch.eldrad
  - service: script.tts_say_eldrad_reset
  - delay:
      hours: 0
      minutes: 0
      seconds: 12
      milliseconds: 0
  - service: switch.turn_on
    target:
      entity_id: switch.eldrad
  mode: single
